<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>계정 정보 수정 - GALLA</title>

    <link rel="stylesheet" href="./css/account-edit.css">
    <link rel="stylesheet" href="./css/index.css">
</head>

<body data-page="account-edit">

<div id="app">

    <!-- HEADER -->
    <header class="header">
        <div class="header-inner">

            <div class="back-btn" onclick="history.back()">←</div>

            <div class="header-title">계정 정보 수정</div>

            <div class="header-spacer"></div>
        </div>
    </header>

    <!-- PROFILE IMAGE -->
    <section class="section">
        <div class="profile-img-wrap">
            <img src="./assets/logo.png" id="profilePreview" class="profile-img">
            <label for="profileInput" class="change-photo">사진 변경</label>
            <input type="file" id="profileInput" accept="image/*" hidden>
        </div>
    </section>

    <!-- INPUTS -->
    <section class="section">

        <div class="input-group">
            <div class="input-label">닉네임</div>
            <input type="text" id="nickname" class="input-field">
        </div>

        <div class="input-group">
            <div class="input-label">소개 문구</div>
            <textarea id="bio" class="input-field textarea"></textarea>
        </div>

        <div class="input-group readonly">
            <div class="input-label">이메일</div>
            <div class="input-value" id="emailField"></div>
        </div>

        <div class="input-group readonly">
            <div class="input-label">전화번호</div>
            <div class="input-value" id="phoneField"></div>
        </div>

    </section>

    <!-- SAVE BUTTON -->
    <section class="section">
        <button class="save-btn" id="saveBtn">저장하기</button>
    </section>

</div>

<!-- ============================= -->
<!-- ⭐ 통일된 NAVIGATION -->
<!-- ============================= -->
<nav class="nav">
    <div class="nav-inner">

        <img src="./assets/icons/nav-home.svg"
             class="nav-icon nav-item"
             data-target="index.html"/>

        <img src="./assets/icons/nav-search.svg"
             class="nav-icon nav-item"
             data-target="search.html"/>

        <img src="./assets/icons/nav-write.svg"
             class="nav-icon nav-item"
             data-target="write.html"/>

        <img src="./assets/icons/nav-random.svg"
             class="nav-icon nav-item"
             data-target="random.html"/>

        <img src="./assets/icons/nav-user.svg"
             class="nav-icon nav-item active"
             data-target="mypage.html"/>

    </div>
</nav>

<script>
/* ======================
   네비게이터
====================== */
document.querySelectorAll(".nav-item").forEach(icon => {
    icon.addEventListener("click", () => {
        const t = icon.dataset.target;
        if (t) location.href = t;
    });
});
</script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="./js/supabase.js"></script>

<script>
/* Supabase 로딩 대기 */
function waitSupabase() {
    return new Promise(resolve => {
        const t = setInterval(() => {
            if (window.supabaseClient) {
                clearInterval(t);
                resolve(window.supabaseClient);
            }
        }, 20);
    });
}

(async () => {
    const supabase = await waitSupabase();
    const { data: sessionData } = await supabase.auth.getSession();

    if (!sessionData.session?.user) {
        alert("로그인이 필요합니다.");
        location.href = "login.html";
        return;
    }

    const user = sessionData.session.user;

    /* ===========================
       1) 기존 유저 정보 불러오기
    ============================ */
    document.getElementById("emailField").textContent = user.email;
    document.getElementById("phoneField").textContent = user.user_metadata.phone || "-";

    document.getElementById("nickname").value =
        user.user_metadata.nickname || "익명의 사용자";

    document.getElementById("bio").value =
        user.user_metadata.bio || "";

    if (user.user_metadata.avatar_url) {
        document.getElementById("profilePreview").src = user.user_metadata.avatar_url;
    }

    /* ===========================
       2) 프로필 이미지 업로드
    ============================ */
    const input = document.getElementById("profileInput");
    const preview = document.getElementById("profilePreview");

    input.addEventListener("change", async () => {
        const file = input.files[0];
        if (!file) return;

        preview.src = URL.createObjectURL(file);

        const fileName = `${user.id}_${Date.now()}.jpg`;

        const { data: storageData, error: storageError } =
            await supabase.storage
                .from("profile")
                .upload(`avatars/${fileName}`, file, { upsert: true });

        if (storageError) {
            alert("이미지 업로드 실패");
            return;
        }

        const { data: publicURL } = supabase.storage
            .from("profile")
            .getPublicUrl(`avatars/${fileName}`);

        await supabase.auth.updateUser({
            data: { avatar_url: publicURL.publicUrl }
        });
    });

    /* ===========================
       3) 저장하기 버튼
    ============================ */
    document.getElementById("saveBtn").addEventListener("click", async () => {
        const nickname = document.getElementById("nickname").value.trim();
        const bio = document.getElementById("bio").value.trim();

        const { error } = await supabase.auth.updateUser({
            data: {
                nickname,
                bio
            }
        });

        if (error) {
            alert("저장 실패\n" + error.message);
        } else {
            alert("저장되었습니다.");
            location.href = "mypage.html";
        }
    });

})();
</script>

<script src="./js/account-edit.js"></script>

</body>
</html>