<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>기부 사용처 - GALLA</title>

    <link rel="stylesheet" href="./css/donation-usage.css">
    <link rel="stylesheet" href="./css/index.css">
    <link rel="stylesheet" href="./css/nav.css">
</head>

<body data-page="mypage">
<div id="app">

    <!-- HEADER -->
    <header class="header">
        <div class="header-inner">
            <img src="assets/icons/back.svg" class="back-icon" onclick="history.back()">
            <div class="header-title">기부 사용처</div>
            <div class="header-spacer"></div>
        </div>
    </header>

    <!-- SUMMARY -->
    <section class="summary-section">
        <div class="summary-card">
            <div class="sum-row">
                <span>총 기부 금액</span>
                <span class="num" id="donationTotal">₩ 0</span>
            </div>
            <div class="sum-row">
                <span>총 기부 횟수</span>
                <span class="num" id="donationCount">0회</span>
            </div>
        </div>
    </section>

    <!-- HISTORY -->
    <section class="history-section">
        <div class="section-title">기부금 사용 내역</div>

        <div id="donationList"></div>
    </section>

</div>

<!-- ============================= -->
<!-- ✅ 통합 NAV -->
<!-- ============================= -->
<nav class="nav">
  <div class="nav-inner">

    <button class="nav-item" data-page="index" data-target="index.html">
      <img
        src="./assets/icons/nav-home.svg"
        data-base="./assets/icons/nav-home.svg"
        data-active="./assets/icons/nav-home-active.svg">
    </button>

    <button class="nav-item" data-page="search" data-target="search.html">
      <img
        src="./assets/icons/nav-search.svg"
        data-base="./assets/icons/nav-search.svg"
        data-active="./assets/icons/nav-search-active.svg">
    </button>

    <button class="nav-item nav-write" data-page="write" data-target="write.html">
      <img
        src="./assets/icons/nav-write.svg"
        data-base="./assets/icons/nav-write.svg"
        data-active="./assets/icons/nav-write-active.svg">
    </button>

    <button class="nav-item" data-page="plaza" data-target="plaza.html">
      <img
        src="./assets/icons/nav-plaza.svg"
        data-base="./assets/icons/nav-plaza.svg"
        data-active="./assets/icons/nav-plaza-active.svg">
    </button>

    <button class="nav-item" data-page="mypage" data-target="mypage.html">
      <img
        src="./assets/icons/nav-user.svg"
        data-base="./assets/icons/nav-user.svg"
        data-active="./assets/icons/nav-user-active.svg">
    </button>

  </div>
</nav>

<script>
/* ===============================
   Supabase 로딩 대기
=============================== */
function waitSupabase() {
    return new Promise(resolve => {
        const timer = setInterval(() => {
            if (window.supabaseClient) {
                clearInterval(timer);
                resolve(window.supabaseClient);
            }
        }, 20);
    });
}

(async () => {
    const supabase = await waitSupabase();

    /* 로그인 체크 */
    const { data: sessionData } = await supabase.auth.getSession();
    if (!sessionData.session?.user) {
        alert("로그인이 필요합니다.");
        location.href = "login.html";
        return;
    }

    const userId = sessionData.session.user.id;

    /* ===============================
       1) 유저 총 기부 금액 & 횟수 조회
       donation_history 테이블 기준
=============================== */
    const { data: summary } = await supabase
        .from("donation_history")
        .select("amount")
        .eq("user_id", userId);

    const total = summary?.reduce((a, b) => a + Number(b.amount), 0) || 0;
    const count = summary?.length || 0;

    document.getElementById("donationTotal").textContent = `₩ ${total.toLocaleString()}`;
    document.getElementById("donationCount").textContent = `${count}회`;

    /* ===============================
       2) 기부 사용처 상세 내역 조회
=============================== */
    const { data: usage } = await supabase
        .from("donation_usage")
        .select("*")
        .eq("user_id", userId)
        .order("used_at", { ascending: false });

    const listEl = document.getElementById("donationList");
    listEl.innerHTML = "";

    if (!usage || usage.length === 0) {
        listEl.innerHTML = `<div class="empty-msg">기부 사용 내역이 없습니다.</div>`;
        return;
    }

    usage.forEach(item => {
        const div = document.createElement("div");
        div.className = "usage-card";

        div.innerHTML = `
            <div class="usage-top">
                <span class="usage-place">${item.place}</span>
                <span class="usage-amount">₩ ${item.amount.toLocaleString()}</span>
            </div>
            <div class="usage-desc">${item.description}</div>
            <div class="usage-date">${item.used_at.split("T")[0]} 사용</div>
        `;

        listEl.appendChild(div);
    });
})();
</script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="js/supabase.js"></script>
<script src="./js/nav.js"></script>

</body>
</html>